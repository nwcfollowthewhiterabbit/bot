# Shift Bot

Телеграм-бот, который проверяет, что пользователь есть в таблице сотрудников и пускает дальше только тех, чей номер указан в Google Sheets.

## Быстрый старт

1. Скопируй файл переменных окружения и подставь токен и параметры доступа к Google Sheets:
   ```bash
   cp .env.example .env
   ```
   * `BOT_TOKEN` — токен твоего Telegram-бота (из BotFather).
   * `GSHEET_ID` и `GSHEET_GID` уже заполнены значениями из таблицы. Если таблица изменится, замени их.
   * `GOOGLE_SERVICE_ACCOUNT_JSON` — JSON-файл сервисного аккаунта Google (в одну строку). Поделись таблицей с адресом сервисного аккаунта, чтобы он мог читать и редактировать листы.
2. Запусти сервис в Docker:
   ```bash
   docker compose up --build
   ```
3. Открой бота в Telegram, набери `/start` и нажми кнопку «Поделиться номером». Бот подтянет твой профиль, определит роль (співробітник/керівник) и покажет доступные действия.

## Файл `.env`

- `.env` никогда не коммить — он добавлен в `.gitignore`.
- Содержимое файла можно подсмотреть в `.env.example`. Там заготовлены нужные ключи и подсказки.
- Google service account JSON нужно свернуть в одну строку и заменить переводы строк `\n` в приватном ключе на литеральные `\\n` (см. пример в шаблоне).
- Если нужно обновить значения, редактируй только локальный `.env` и перезапусти контейнер (`docker compose up --build`), чтобы бот увидел изменения.

## Docker-контейнер

Сервис упакован в контейнер через `Dockerfile`. Ты можешь собрать образ вручную:

```bash
docker build -t shift-bot .
```

И запустить его напрямую:

```bash
docker run --env-file .env --rm shift-bot
```

Но обычно достаточно `docker compose up --build`, который соберёт образ и перезапустит его при изменениях.

## Публикация кода в GitHub

1. Инициализируй репозиторий и укажи удалённый репозиторий (замени `USERNAME` и `shift-bot` на свои значения):
   ```bash
   git init
   git branch -m main
   git remote add origin git@github.com:USERNAME/shift-bot.git
   ```
2. Добавь файлы и сделай коммит:
   ```bash
   git add .
   git commit -m "Initial commit"
   ```
3. Отправь изменения в GitHub:
   ```bash
   git push -u origin main
   ```

В GitHub Actions (если они понадобятся) можно хранить секреты `BOT_TOKEN`, `GSHEET_ID`, `GSHEET_GID`, `GOOGLE_SERVICE_ACCOUNT_JSON`, чтобы не хранить их в открытом виде.

## Как это работает

- Вкладка `Співробітники` хранит данные о телефонах, ролях, ставках и привязке к керівникам. По контакту определяется доступ и меню.
- **Співробітник** может:
  - подать заявку на зміну (дата, кількість годин, овертайм, коментар);
  - смотреть свои заявки за последние 7 дней и все, что еще в статусе «Очікує».
- Заявки пишутся на лист `Зміни` c авто-ID и статусом «Очікує». Дата/час подачи ставятся автоматически.
- **Керівник** в меню отримує кнопки: `В очікуванні`, `Мої співробітники`, `Переглянути таблицю`. Перша показує заявки підлеглих, друга — список команди з контактами й ставками, третя відкриває Google Sheets. Під час перегляду заявок доступні кнопки підтвердження/відхилення з коментарем.
- При старті бот синхронізує валідації у листі `Співробітники`: у колонці `Роль` доступні варіанти «Керівник»/«Співробітник», а в колонці `Керівник` — випадаючий список з усіх керівників.
- При подтверждении заявки создается запись на листе `Нарахування`: суммируются оплата за зміну и овертайм по ставкам сотрудника.
- Все операции с Google Sheets выполняются от имени сервисного аккаунта; бот работает без собственной базы.

## Полезные команды

- Остановить сервис: `docker compose down`.
- Обновить зависимости: отредактируй `requirements.txt` и перезапусти `docker compose up --build`.
